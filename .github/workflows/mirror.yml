name: Mirror commits

on:
  workflow_call:
    inputs:
      branch:
        description: Branch to mirror commits from. Same branch must exist on the public repo.
        type: string
        required: true
    secrets:
      TECHRIDER_SSH_PUBLIC_KEY:
        description: TechRider SSH public key
        required: true
      TECHRIDER_SSH_PRIVATE_KEY:
        description: TechRider SSH private key
        required: true

env:
  PUBLIC_REPO: 'WingRiders/multi-dex-launchpad'  # Define public repo here

jobs:
  mirror:
    name: Mirror commits to public repo
    runs-on: ubuntu-latest
    if: endsWith(github.repository, '-private') # Prevent execution in the public repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import SSH key
        shell: bash
        env:
          TECHRIDER_SSH_PUBLIC_KEY: ${{ secrets.TECHRIDER_SSH_PUBLIC_KEY }}
          TECHRIDER_SSH_PRIVATE_KEY: ${{ secrets.TECHRIDER_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$TECHRIDER_SSH_PUBLIC_KEY" >~/.ssh/id_ed25519.pub
          echo "$TECHRIDER_SSH_PRIVATE_KEY" >~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub

      - name: Fetch public remote
        shell: bash
        run: |
          git remote add public git@github.com:$PUBLIC_REPO.git
          git fetch public ${{ inputs.branch }} || echo "No remote public repo branch to fetch"

      - name: Set TechRiderWR as the author
        shell: bash
        run: |
          git config --local user.name "TechRiderWR"
          git config --local user.email "techrider@wingriders.com"

      - name: Rewrite commit history
        shell: bash
        run: |
          if git show-ref --quiet refs/remotes/public/${{ inputs.branch }}; then
            # Number of commits on the public branch
            publicCommitsCount=$(git rev-list --count public/${{ inputs.branch }})
          
            # The first divergent commit on private branch (empty when private has no commits beyond public)
            firstDivergentCommit=$(git rev-list --reverse HEAD | tail -n +$((publicCommitsCount+1)) | head -1)
            echo "firstDivergentCommit is $firstDivergentCommit"
            
            if [ -n "$firstDivergentCommit" ]; then
              # Rebase all private commits on the public ones
              git rebase "$firstDivergentCommit~1" --exec "git commit --amend --no-edit --reset-author" --onto public/${{ inputs.branch }}
            
              # Filter out the Co-authored-by lines and continue with the history cleaning
              FILTER_BRANCH_SQUELCH_WARNING=1 git filter-branch --msg-filter "sed -n '/Co-authored-by/Iq;p'" "$firstDivergentCommit~1..HEAD"
            else
              echo "Not rebasing, the commit history is of the same length"
            fi
          else
            echo "Public branch does not exist â€“ anonymizing entire history"
          
            # --reset-author does not suffice, the values from git config are used only when creating/amending commit
            FILTER_BRANCH_SQUELCH_WARNING=1 git filter-branch \
              --env-filter '
                export GIT_AUTHOR_NAME="TechRiderWR"
                export GIT_AUTHOR_EMAIL="techrider@wingriders.com"
                export GIT_COMMITTER_NAME="TechRiderWR"
                export GIT_COMMITTER_EMAIL="techrider@wingriders.com"
              ' --msg-filter "sed -n '/Co-authored-by/Iq;p'" HEAD
          fi

          # Finally, show the commit log for verification
          git log --pretty="format:%an <%ae> (%h): %s"

      - name: Push to public repo
        shell: bash
        run: |
          git push public HEAD:${{ inputs.branch }} # HEAD for case the job is not run on the ${{ inputs.branch }} branch
