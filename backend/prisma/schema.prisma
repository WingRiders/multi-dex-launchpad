generator client {
  provider = "prisma-client"
  output   = "./generated"
  runtime  = "bun"
}

datasource db {
  provider = "postgresql"
}

model Block {
  slot   Int    @id
  height Int
  hash   String @db.VarChar(64)

  createdLaunches Launch[] @relation("createdLaunch")

  txOutputs      TxOutput[] @relation("created")
  spentTxOutputs TxOutput[] @relation("spent")
}

model TxOutput {
  txHash      String
  outputIndex Int

  address String

  datum     String?
  datumHash String?

  scriptLanguage String? // native | plutus:v1 | plutus:v2 | plutus:v3
  scriptCbor     String?

  // policy id -> asset name -> quantity
  // comes from Ogmios, serialized with superjson
  value Json

  slot  Int
  block Block @relation("created", fields: [slot], references: [slot], onDelete: Cascade)

  // NOTE: we enforce spentTxHash is set to null together with spentSlot with a trigger
  spentTxHash String?
  spentSlot   Int?
  spentBlock  Block?  @relation("spent", fields: [spentSlot], references: [slot], onDelete: SetNull)

  // tracked utxos
  nodes                     Node[]
  rewardsHolders            RewardsHolder[]
  failProofs                FailProof[]
  firstProjectTokensHolders FirstProjectTokensHolder[]
  finalProjectTokensHolders FinalProjectTokensHolder[]
  commitFolds               CommitFold[]
  rewardsFolds              RewardsFold[]
  poolProofs                PoolProof[]
  wrPools                   WrPool[]
  sundaePools               SundaePool[]

  refScriptCarriers RefScriptCarrier[]

  @@id([txHash, outputIndex])
}

model Node {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  keyHash     String?
  keyIndex    Int?
  nextHash    String?
  nextIndex   Int?
  committed   BigInt
  createdTime BigInt

  @@unique([txHash, outputIndex, launchTxHash])
}

model RewardsHolder {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  ownerHash  String?
  ownerIndex Int?

  @@unique([txHash, outputIndex, launchTxHash])
}

model FailProof {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  @@unique([txHash, outputIndex, launchTxHash])
}

model FirstProjectTokensHolder {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  @@unique([txHash, outputIndex, launchTxHash])
}

model FinalProjectTokensHolder {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  @@unique([txHash, outputIndex, launchTxHash])
}

model CommitFold {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  nextKeyHash    String?
  nextKeyIndex   Int?
  cutoffKeyHash  String?
  cutoffKeyIndex Int?
  cutoffTime     BigInt? // POSIXTime
  committed      BigInt
  overcommitted  BigInt
  nodeCount      Int
  ownerAddress   String

  @@unique([txHash, outputIndex, launchTxHash])
}

model RewardsFold {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  @@unique([txHash, outputIndex, launchTxHash])
}

enum PoolProofType {
  SUNDAE
  WR
}

model PoolProof {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  type PoolProofType

  @@unique([txHash, outputIndex, launchTxHash])
}

model WrPool {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  @@unique([txHash, outputIndex, launchTxHash])
}

model SundaePool {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  @@unique([txHash, outputIndex, launchTxHash])
}

// NOTE: only generated contracts are tracked in the db
//       constant contract are deployed once
//       and stored as constants directly in the codebase
enum RefScriptCarrierType {
  NODE_VALIDATOR
  NODE_POLICY
  FIRST_PROJECT_TOKENS_HOLDER_VALIDATOR
  PROJECT_TOKENS_HOLDER_POLICY
  FINAL_PROJECT_TOKENS_HOLDER_VALIDATOR
  COMMIT_FOLD_VALIDATOR
  COMMIT_FOLD_POLICY
  REWARDS_FOLD_VALIDATOR
  REWARDS_FOLD_POLICY
}

model RefScriptCarrier {
  txHash       String
  outputIndex  Int
  txOut        TxOutput @relation(fields: [txHash, outputIndex], references: [txHash, outputIndex], onDelete: Cascade)
  launchTxHash String
  launch       Launch   @relation(fields: [launchTxHash], references: [txHash], onDelete: Cascade)

  type RefScriptCarrierType

  @@unique([txHash, outputIndex, launchTxHash])
}

// NOTE: we don't need the status since we can infer it from other fields
model Launch {
  // NOTE: each launch is uniquely identified by its first transaction
  txHash String @id
  slot   Int
  block  Block  @relation("createdLaunch", fields: [slot], references: [slot], onDelete: Cascade)

  // Project info
  projectTitle                 String
  projectDescription           String
  projectUrl                   String
  projectLogoUrl               String
  projectTokenomicsUrl         String
  projectWhitepaperUrl         String?
  projectTermsAndConditionsUrl String?
  projectAdditionalUrl         String?

  // Tracked utxos
  // They are stored in separate tables so that
  // rollback handling would not loose any data.
  // If we were to store them in this table linking against TxOutput
  // we would not be able to find, e.g., the previous rewards fold in case
  // its utxo is rolled back
  // Some utxos do not require that (fail proofs / pool proofs are unspendable)
  // but they are handled the same for consistency
  nodes                     Node[]
  rewardsHolders            RewardsHolder[]
  failProofs                FailProof[]
  firstProjectTokensHolders FirstProjectTokensHolder[]
  finalProjectTokensHolders FinalProjectTokensHolder[]
  commitFolds               CommitFold[]
  rewardsFolds              RewardsFold[]
  poolProofs                PoolProof[]
  wrPools                   WrPool[]
  sundaePools               SundaePool[]

  refScriptCarriers RefScriptCarrier[]

  // The configuration is available as soon as the transaction is parsed.
  // We store it inline in the launch table.

  // The owner of the launch, supplies the project tokens
  ownerBech32Address                 String
  // A value between 0 and 10_000, specifies a split of liquidity between Sundae and Wr pools
  // 0 means everything goes to Sundae
  // 10_000 means everything goes to Wr
  splitBps                           Int
  // The script hash of the Wr V2 Constant Product pool
  wrPoolValidatorHash                String
  // The script hash of the Wr V2 factory
  wrFactoryValidatorHash             String
  // The currency symbol of the Wr V2 pool policy
  wrPoolCurrencySymbol               String
  // The script hash of the Sundae V3 pool
  sundaePoolScriptHash               String
  // The max amount of ada it is tolerable to pay to create a Sundae pool
  // Note that the actual amount is hopefully less and is controlled by the Sundae settings utxo.
  // In case the settings specify a value above the tolerance, no Sundae pool is created.
  sundaeFeeTolerance                 BigInt
  // The currency symbol of the Sundae settings NFT.
  sundaeSettingsCurrencySymbol       String
  // The start time must be set to the lowest of the tiers start times.
  startTime                          BigInt
  // The time after which users no longer can contribute to nor withdraw from the launch.
  endTime                            BigInt
  // The asset that is being launched
  projectTokenPolicyId               String
  projectTokenAssetName              String
  // The asset that is being raised
  raisingTokenPolicyId               String
  raisingTokenAssetName              String
  // The min possible amount of tokens the launch can raise.
  // In case less raised tokens are collected, the launch is considered failed and tokens are returned back.
  projectMinCommitment               BigInt
  // The maximum amount of tokens the launch can raise.
  // Can be set to max int64 value to essentially remove the cap.
  projectMaxCommitment               BigInt
  // The total number of the project tokens committed to the launch.
  totalTokens                        BigInt
  // The number of the project tokens to distribute among the launch users.
  tokensToDistribute                 BigInt
  // The percentage of the raised tokens to place into the pool.
  raisedTokensPoolPartPercentage     Int
  // Controls the dao fee collected in raised tokens
  daoFeeNumerator                    Int
  // Controls the dao fee collected in raised tokens
  daoFeeDenominator                  Int
  // Controls the address where the dao fee is sent
  daoFeeReceiverBech32Address        String
  // Controls the pub key hash of a dao admin.
  // This signer can add separator nodes (the launch owner can do that as well).
  daoAdminPubKeyHash                 String
  // How much collateral (in Lovelace) is locked into the launch
  // Must be at least 2 ada per used DEX plus 2 ada for the dao fee utxo
  // The rest is returned if the launch is successful.
  // If the launch is failed, the collateral is split between the commit fold owner and the dao fee receiver
  collateral                         BigInt
  // The tx out ref of the utxo that has to be spent to uniquely identify a launch
  starterTxHash                      String
  starterOutputIndex                 BigInt
  // Configures the duration period of the vesting utxo which holds the owner's shares
  vestingPeriodDuration              BigInt
  // Configures the duration period to first unlock of the vesting utxo which holds the owner's shares
  vestingPeriodDurationToFirstUnlock BigInt
  // Configures the number of installments of the vesting utxo which holds the owner's shares
  vestingPeriodInstallments          Int
  // Configures the start of the vesting utxo which holds the owner's shares
  vestingPeriodStart                 BigInt
  // Configures the validator hash of the vesting utxo which holds the owner's shares
  vestingValidatorHash               String
  // Policy ID of the presale tier token
  // Note that the token name is not checked.
  // That allows using NFTs on the same policy as presale tokens.
  presaleTierCs                      String
  // The commitment start time of the presale tier
  presaleTierStartTime               BigInt
  // The commitment start time of the default tier
  defaultStartTime                   BigInt
  // The min user commitment of the presale tier
  presaleTierMinCommitment           BigInt
  // The min user commitment of the default tier
  defaultTierMinCommitment           BigInt
  // The max user commitment of the presale tier
  presaleTierMaxCommitment           BigInt
  // The max user commitment of the  tier
  defaultTierMaxCommitment           BigInt
  // The amount of ada a commitment node must hold.
  // This ada is used up to compensate the folds and to create a user rewards holder.
  nodeAda                            BigInt
  // The amount of ada the commit fold gets per each folded node.
  commitFoldFeeAda                   BigInt
  // The min amount of ada various utxos are expected to held.
  // This includes the rewards holder, dao fee, and final project tokens holder.
  oilAda                             BigInt
}
